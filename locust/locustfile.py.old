import logging
import random

from locust import HttpUser, between, task

SOTONGPT_TOKEN_ADMIN = "sk-3357a902e7724a3897cbe28d77ef44cb"
SOTONGPT_TOKEN_USER = "sk-d6c203c1c53f43eb91892627a028ac9a"
REQUEST_HEADERS = {"Authorization": f"Bearer {SOTONGPT_TOKEN_USER}"}

logging.basicConfig(
    level=logging.INFO, format="%(asctime)s - %(name)s - %(levelname)s - %(message)s"
)
logger = logging.getLogger(__name__)


class APIUser(HttpUser):
    """Stress tests for the API endpoints."""

    wait_time = between(15, 60)

    @task
    def list_models(self):
        """Models endpoint for listing which models are available."""
        self.client.get("/api/models", headers=REQUEST_HEADERS)

    @task
    def create_completion(self):
        """Chat completion endpoints for generating a chat response."""
        model_choices = [
            "qwen3-32b",
            "qwen25-14b-instruct",
            "tiny-llama",
        ]
        prompt_choices = [
            "Explain quantum computing in simple terms suitable for a 12-year-old, using clear analogies.",
            "Create a step-by-step plan to learn Python from beginner to intermediate level in three months.",
            "Compare the advantages and disadvantages of remote work versus office work, with practical examples.",
            "Write a short science fiction story set in a floating city where gravity occasionally fails.",
            "Draft a concise, professional email requesting a project deadline extension due to unexpected technical issues.",
        ]
        header = {**REQUEST_HEADERS, "Content-Type": "application/json"}
        response = self.client.post(
            "/api/chat/completions",
            json={
                "model": random.choice(model_choices),
                "messages": [
                    {"role": "user", "content": random.choice(prompt_choices)}
                ],
            },
            headers=header,
        )

        logger.info(
            f"create_completion - Status: {response.status_code}, "
            f"Response: {response.content}..."
        )
